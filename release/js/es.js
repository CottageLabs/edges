var es={specialChars:["\\","+","-","=","&&","||",">","<","!","(",")","{","}","[","]","^",'"',"~","*","?",":","/"],specialCharsSubSet:["\\","+","-","=","&&","||",">","<","!","(",")","{","}","[","]","^","~","?",":","/"],characterPairs:['"'],distanceUnits:["km","mi","miles","in","inch","yd","yards","kilometers","mm","millimeters","cm","centimeters","m","meters"],aggregationFactory:function(t,e){var i={terms:es.newTermsAggregation,range:es.newRangeAggregation,geo_distance:es.newGeoDistanceAggregation,date_histogram:es.newDateHistogramAggregation,stats:es.StatsAggregation};return i[t]?i[t](e):void 0},filterFactory:function(t,e){var i={query_string:es.newQueryString,term:es.newTermFilter,terms:es.newTermsFilter,range:es.newRangeFilter,geo_distance_range:es.newGeoDistanceRangeFilter};return i[t]?i[t](e):void 0},newQuery:function(t){return t||(t={}),new es.Query(t)},Query:function(t){this.filtered=t.filtered||!0,this.size=void 0!==t.size?t.size:!1,this.from=t.from||!1,this.fields=t.fields||[],this.aggs=t.aggs||[],this.must=t.must||[],this.queryString=!1,this.sort=[],this.source=t.source||!1,this.should=t.should||[],this.mustNot=t.mustNot||[],this.partialFields=t.partialFields||!1,this.scriptFields=t.scriptFields||!1,this.minimumShouldMatch=t.minimumShouldMatch||!1,this.partialFields=t.partialFields||!1,this.scriptFields=t.scriptFields||!1,this.facets=t.facets||[],this.getSize=function(){return void 0!==this.size&&this.size!==!1?this.size:10},this.getFrom=function(){return this.from?this.from:0},this.addField=function(t){-1===$.inArray(t,this.fields)&&this.fields.push(t)},this.setQueryString=function(t){var e=t;t instanceof es.QueryString||(e=$.isPlainObject(t)?es.newQueryString(t):es.newQueryString({queryString:t})),this.queryString=e},this.getQueryString=function(){return this.queryString},this.removeQueryString=function(){this.queryString=!1},this.setSortBy=function(t){this.sort=[];var e=t;$.isArray(t)||(e=[t]);for(var i=0;i<e.length;i++)this.addSortBy(e[i])},this.addSortBy=function(t){var e=t;t instanceof es.Sort||(e=es.newSort(t));for(var i=0;i<this.sort.length;i++){var s=this.sort[i];if(s.field===e.field)return}this.sort.push(e)},this.prependSortBy=function(t){var e=t;t instanceof es.Sort||(e=es.newSort(t)),this.removeSortBy(e),this.sort.unshift(e)},this.removeSortBy=function(t){var e=t;t instanceof es.Sort||(e=es.newSort(t));for(var i=[],s=0;s<this.sort.length;s++){var r=this.sort[s];r.field===e.field&&i.push(s)}i=i.sort().reverse();for(var s=0;s<i.length;s++)this.sort.splice(i[s],1)},this.getSortBy=function(){return this.sort},this.setSource=function(t,e){},this.addFacet=function(){},this.removeFacet=function(){},this.clearFacets=function(){},this.getAggregation=function(t){for(var e=t.name,i=0;i<this.aggs.length;i++){var s=this.aggs[i];if(s.name===e)return s}},this.addAggregation=function(t,e){if(e)this.removeAggregation(t.name);else for(var i=0;i<this.aggs.length;i++)if(this.aggs[i].name===t.name)return;this.aggs.push(t)},this.removeAggregation=function(t){for(var e=[],i=0;i<this.aggs.length;i++)this.aggs[i].name===t&&e.push(i);e=e.sort().reverse();for(var i=0;i<e.length;i++)this.aggs.splice(e[i],1)},this.clearAggregations=function(){this.aggs=[]},this.listAggregations=function(){return this.aggs},this.addMust=function(t){var e=this.listMust(t);0===e.length&&this.must.push(t)},this.listMust=function(t){return this.listFilters({boolType:"must",template:t})},this.removeMust=function(t){for(var e=[],i=0;i<this.must.length;i++){var s=this.must[i];s.matches(t)&&e.push(i)}e=e.sort().reverse();for(var i=0;i<e.length;i++)this.must.splice(e[i],1)},this.clearMust=function(){},this.addShould=function(){},this.listShould=function(){},this.removeShould=function(){},this.clearShould=function(){},this.addMustNot=function(){},this.listMustNot=function(){},this.removeMustNot=function(){},this.removeMustNot=function(){},this.hasFilters=function(){return this.must.length>0||this.should.length>0||this.mustNot.length>0},this.listFilters=function(t){var e=t.boolType||"must",i=t.template||!1,s=[];if("must"===e?s=this.must:"should"===e?s=this.should:"must_not"===e&&(s=this.mustNot),!i)return s;for(var r=[],n=0;n<s.length;n++){var a=s[n];a.matches(i)&&r.push(a)}return r},this.merge=function(t){if(this.filtered=t.filtered,t.size&&(this.size=t.size),t.from&&(this.from=t.from),t.fields&&t.fields.length>0)for(var e=0;e<t.fields.length;e++)this.addField(t.fields[e]);for(var i=t.listAggregations(),e=0;e<i.length;e++)this.addAggregation(i[e],!0);for(var s=t.listMust(),e=0;e<s.length;e++)this.addMust(s[e]);t.getQueryString()&&this.setQueryString(t.getQueryString());var r=t.getSortBy();if(r&&r.length>0){r.reverse();for(var e=0;e<r.length;e++)this.prependSortBy(r[e])}},this.objectify=function(t){t||(t={});var e=void 0===t.include_query_string?!0:t.include_query_string,i=void 0===t.include_filters?!0:t.include_filters,s=void 0===t.include_paging?!0:t.include_paging,r=void 0===t.include_sort?!0:t.include_sort,n=void 0===t.include_fields?!0:t.include_fields,a=void 0===t.include_aggregations?!0:t.include_aggregations,h=(void 0===t.include_facets?!0:t.include_facets,{}),o={},g={};if(this.queryString&&e&&$.extend(o,this.queryString.objectify()),i&&this.must.length>0){for(var u=[],l=0;l<this.must.length;l++){var f=this.must[l];u.push(f.objectify())}g.must=u}if(this.filtered&&this.hasFilters()?(0==Object.keys(o).length&&(o.match_all={}),h.query={filtered:{filter:{bool:g},query:o}}):(this.hasFilters()&&(o.bool=g),0==Object.keys(o).length&&(o.match_all={}),h.query=o),s&&(void 0!==this.size&&this.size!==!1&&(h.size=this.size),this.from&&(h.from=this.from)),this.sort.length>0&&r){h.sort=[];for(var l=0;l<this.sort.length;l++)h.sort.push(this.sort[l].objectify())}if(this.fields.length>0&&n&&(h.fields=this.fields),this.aggs.length>0&&a){h.aggs={};for(var l=0;l<this.aggs.length;l++){var c=this.aggs[l];$.extend(h.aggs,c.objectify())}}return h},this.parse=function(t){function e(t,e){if(t.must)for(var i=0;i<t.must.length;i++){var s=Object.keys(t.must[i])[0],r=es.filterFactory(s,{raw:t.must[i]});r&&e.addMust(r)}}function i(t,e){for(var i=Object.keys(t),s=0;s<i.length;s++){var r=i[s],n=es.filterFactory(r,{raw:t[r]});n&&"query_string"===r&&e.setQueryString(n)}}if(t.query)if(t.query.filtered){this.filtered=!0;var s=t.query.filtered.filter.bool;s&&e(s,this);var r=t.query.filtered.query;i(r,this)}else{var r=t.query;i(r,this)}if(t.size&&(this.size=t.size),t.from&&(this.from=t.from),t.fields&&(this.fields=t.fields),t.sort)for(var n=0;n<t.sort.length;n++){var a=t.sort[n];this.addSortBy(es.newSort({raw:a}))}if(t.aggs||t.aggregations)for(var h=t.aggs?t.aggs:t.aggregations,o=Object.keys(h),n=0;n<o.length;n++){var g=o[n],u=h[g],l=Object.keys(u)[0],f={};f[g]=u;var c=es.aggregationFactory(l,{raw:f});c&&this.addAggregation(c)}},t.queryString&&this.setQueryString(t.queryString),t.sort&&this.setSortBy(t.sort),t.raw&&this.parse(t.raw)},newQueryString:function(t){return t||(t={}),new es.QueryString(t)},QueryString:function(t){this.queryString=t.queryString||!1,this.defaultField=t.defaultField||!1,this.defaultOperator=t.defaultOperator||"OR",this.fuzzify=t.fuzzify||!1,this.escapeSet=t.escapeSet||es.specialCharsSubSet,this.pairs=t.pairs||es.characterPairs,this.unEscapeSet=t.unEscapeSet||es.specialChars,this.objectify=function(){var t=this._escape(this._fuzzify(this.queryString)),e={query_string:{query:t}};return this.defaultOperator&&(e.query_string.default_operator=this.defaultOperator),this.defaultField&&(e.query_string.default_field=this.defaultField),e},this.parse=function(t){t.query_string&&(t=t.query_string),this.queryString=this._unescape(t.query),t.default_operator&&(this.defaultOperator=t.default_operator),t.default_field&&(this.defaultField=t.default_field)},this._fuzzify=function(t){if(!this.fuzzify||"*"!==this.fuzzify&&"~"!==this.fuzzify)return t;if(-1!==t.indexOf("*")||-1!==t.indexOf("~")||-1!==t.indexOf(":"))return t;for(var e="",i=t.split(" "),s=0;s<i.length;s++){var r=i[s];r.length>0&&(r+=this.fuzzify,"*"==this.fuzzify?r="*"+r:!1,e+=r+" ")}return e},this._escapeRegExp=function(t){return t.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},this._replaceAll=function(t,e,i){return t.replace(new RegExp(this._escapeRegExp(e),"g"),i)},this._unReplaceAll=function(t,e){return t.replace(new RegExp("\\\\("+this._escapeRegExp(e)+")","g"),"$1")},this._paired=function(t,e){var i=t.match(new RegExp(this._escapeRegExp(e),"g"))||[];return i.length%2===0},this._escape=function(t){for(var e=this.escapeSet.slice(0),i=0;i<this.pairs.length;i++){var s=this.pairs[i];this._paired(t,s)||e.push(s)}for(var i=0;i<e.length;i++){var s=e[i];t=this._replaceAll(t,s,"\\"+s)}return t},this._unescape=function(t){for(var e=0;e<this.unEscapeSet.length;e++){var i=this.unEscapeSet[e];t=this._unReplaceAll(t,i)}return t},t.raw&&this.parse(t.raw)},newSort:function(t){return t||(t={}),new es.Sort(t)},Sort:function(t){this.field=t.field||"_score",this.order=t.order||"desc",this.objectify=function(){var t={};return t[this.field]={order:this.order},t},this.parse=function(t){this.field=Object.keys(t)[0],t[this.field].order&&(this.order=t[this.field].order)},t.raw&&this.parse(t.raw)},newAggregation:function(t){return t||(t={}),new es.Aggregation(t)},Aggregation:function(t){this.name=t.name,this.aggs=t.aggs||[],this.addAggregation=function(t){for(var e=0;e<this.aggs.length;e++)if(this.aggs[e].name===t.name)return;this.aggs.push(t)},this.removeAggregation=function(){},this.clearAggregations=function(){},this._make_aggregation=function(t,e){var i={};if(i[this.name]={},i[this.name][t]=e,this.aggs.length>0){i[this.name].aggs={};for(var s=0;s<this.aggs.length;s++)$.extend(i[this.name].aggs,this.aggs[s].objectify())}return i},this._parse_wrapper=function(t,e){this.name=Object.keys(t)[0];var i=t[this.name][e],s=t[this.name].aggs?t[this.name].aggs:t[this.name].aggregations;if(s)for(var r=Object.keys(s),n=0;n<r.length;n++){var a=r[n],h=s[r[n]],o=Object.keys(h)[0],g={};g[a]=h;var u=es.aggregationFactory(o,{raw:g});u&&this.addAggregation(u)}return i}},newTermsAggregation:function(t){return t||(t={}),es.TermsAggregation.prototype=es.newAggregation(t),new es.TermsAggregation(t)},TermsAggregation:function(t){this.field=t.field||!1,this.size=t.size||10,this.orderBy="_count",t.orderBy&&(this.orderBy=t.orderBy,"_"!==this.orderBy[0]&&(this.orderBy="_"+this.orderBy)),this.orderDir=t.orderDir||"desc",this.setOrdering=function(t,e){this.orderBy=t,"_"!==this.orderBy[0]&&(this.orderBy="_"+this.orderBy),this.orderDir=e},this.objectify=function(){var t={field:this.field,size:this.size,order:{}};return t.order[this.orderBy]=this.orderDir,this._make_aggregation("terms",t)},this.parse=function(t){var e=this._parse_wrapper(t,"terms");this.field=e.field,e.size&&(this.size=e.size),e.order&&(this.orderBy=Object.keys(e.order)[0],this.orderDir=e.order[this.orderBy])},t.raw&&this.parse(t.raw)},newRangeAggregation:function(t){return t||(t={}),es.RangeAggregation.prototype=es.newAggregation(t),new es.RangeAggregation(t)},RangeAggregation:function(t){this.field=t.field||!1,this.ranges=t.ranges||[],this.objectify=function(){var t={field:this.field,ranges:this.ranges};return this._make_aggregation("range",t)},this.parse=function(t){var e=this._parse_wrapper(t,"range");this.field=e.field,this.ranges=e.ranges},t.raw&&this.parse(t.raw)},newGeoDistanceAggregation:function(t){return t||(t={}),es.GeoDistanceAggregation.prototype=es.newAggregation(t),new es.GeoDistanceAggregation(t)},GeoDistanceAggregation:function(t){this.field=t.field||!1,this.lat=t.lat||!1,this.lon=t.lon||!1,this.unit=t.unit||"m",this.distance_type=t.distance_type||"sloppy_arc",this.ranges=t.ranges||[],this.objectify=function(){var t={field:this.field,origin:{lat:this.lat,lon:this.lon},unit:this.unit,distance_type:this.distance_type,ranges:this.ranges};return this._make_aggregation("geo_distance",t)},this.parse=function(t){var e=this._parse_wrapper(t,"range");this.field=e.field;var i=e.origin;i.lat&&(this.lat=i.lat),i.lon&&(this.lon=i.lon),e.unit&&(this.unit=e.unit),e.distance_type&&(this.distance_type=e.distance_type),this.ranges=e.ranges},t.raw&&this.parse(t.raw)},newStatsAggregation:function(t){return t||(t={}),es.StatsAggregation.prototype=es.newAggregation(t),new es.StatsAggregation(t)},StatsAggregation:function(t){this.field=t.field||!1,this.objectify=function(){var t={field:this.field};return this._make_aggregation("stats",t)},this.parse=function(t){},t.raw&&this.parse(t.raw)},newDateHistogramAggregation:function(t){return t||(t={}),es.DateHistogramAggregation.prototype=es.newAggregation(t),new es.DateHistogramAggregation(t)},DateHistogramAggregation:function(t){this.field=t.field||!1,this.interval=t.interval||"month",this.format=t.format||!1,this.objectify=function(){var t={field:this.field,interval:this.interval};return this.format&&(t.format=this.format),this._make_aggregation("date_histogram",t)},this.parse=function(t){var e=this._parse_wrapper(t,"date_histogram");this.field=e.field,e.interval&&(this.interval=e.interval),e.format&&(this.format=e.format)},t.raw&&this.parse(t.raw)},newFilter:function(t){return t||(t={}),new es.Filter(t)},Filter:function(t){this.field=t.field,this.type_name=t.type_name,this.matches=function(t){return t.type_name!==this.type_name?!1:t.field&&t.field!==this.field?!1:!0},this.objectify=function(){},this.parse=function(){}},newTermFilter:function(t){return t||(t={}),t.type_name="term",es.TermFilter.prototype=es.newFilter(t),new es.TermFilter(t)},TermFilter:function(t){this.value=t.value||!1,this.matches=function(t){var e=Object.getPrototypeOf(this).matches.call(this,t);return e?t.value&&t.value!==this.value?!1:!0:!1},this.objectify=function(){var t={term:{}};return t.term[this.field]=this.value,t},this.parse=function(t){t.term&&(t=t.term),this.field=Object.keys(t)[0],this.value=t[this.field]},t.raw&&this.parse(t.raw)},newTermsFilter:function(t){return t||(t={}),t.type_name="terms",es.TermsFilter.prototype=es.newFilter(t),new es.TermsFilter(t)},TermsFilter:function(t){this.values=t.values||!1,this.execution=t.execution||!1,this.matches=function(t){var e=Object.getPrototypeOf(this).matches.call(this,t);if(!e)return!1;if(t.values){if(t.values.length!==this.values.length)return!1;for(var i=0;i<t.values.length;i++)if(-1===$.inArray(t.values[i],this.values))return!1}return!0},this.objectify=function(){var t=this.values||[],e={terms:{}};return e.terms[this.field]=t,this.execution&&(e.terms.execution=this.execution),e},this.parse=function(t){t.terms&&(t=t.terms),this.field=Object.keys(t)[0],this.values=t[this.field],t.execution&&(this.execution=t.execution)},this.add_term=function(t){this.values||(this.values=[]),-1===$.inArray(t,this.values)&&this.values.push(t)},this.has_term=function(t){return this.values?$.inArray(t,this.values)>=0:!1},this.remove_term=function(t){if(this.values){var e=$.inArray(t,this.values);e>=0&&this.values.splice(e,1)}},this.has_terms=function(){return this.values!==!1&&this.values.length>0},this.term_count=function(){return this.values===!1?0:this.values.length},t.raw&&this.parse(t.raw)},newRangeFilter:function(t){return t||(t={}),t.type_name="range",es.RangeFilter.prototype=es.newFilter(t),new es.RangeFilter(t)},RangeFilter:function(t){this.lt=t.lt||!1,this.gte=t.gte||!1,this.matches=function(t){var e=Object.getPrototypeOf(this).matches.call(this,t);return e?t.lt&&t.lt!==this.lt?!1:t.gte&&t.gte!==this.gte?!1:!0:!1},this.objectify=function(){var t={range:{}};return t.range[this.field]={},this.lt&&(t.range[this.field].lt=this.lt),this.gte&&(t.range[this.field].gte=this.gte),t},this.parse=function(t){t.range&&(t=t.range),this.field=Object.keys(t)[0],t[this.field].lt&&(this.lt=t[this.field].lt),t[this.field].gte&&(this.gte=t[this.field].gte)},t.raw&&this.parse(t.raw)},newGeoDistanceRangeFilter:function(t){return t||(t={}),t.type_name="geo_distance_range",es.GeoDistanceRangeFilter.prototype=es.newFilter(t),new es.GeoDistanceRangeFilter(t)},GeoDistanceRangeFilter:function(t){this.lt=t.lt||!1,this.gte=t.gte||!1,this.lat=t.lat||!1,this.lon=t.lon||!1,this.unit=t.unit||"m",this.objectify=function(){var t={geo_distance_range:{}};return t.geo_distance_range[this.field]={lat:this.lat,lon:this.lon},this.lt&&(t.geo_distance_range.lt=this.lt+this.unit),this.gte&&(t.geo_distance_range.gte=this.gte+this.unit),t},this.parse=function(t){function e(t,e){return-1!==t.indexOf(e,t.length-e.length)}function i(t){for(var i=!1,s=0;s<es.distanceUnits.length;s++){var r=es.distanceUnits[s];e(t,r)&&(t=t.substring(0,t.length-r.length),i=t.substring(t.length-r.length))}return[t,i]}t.geo_distance_range&&(t=t.geo_distance_range),this.field=Object.keys(t)[0],this.lat=t[this.field].lat,this.lon=t[this.field].lon;var s=t[this.field].lt,r=t[this.field].gte;if(s){s=s.trim();var n=i(s);this.lt=n[0],this.unit=n[1]}if(r){r=r.trim();var n=i(r);this.gte=n[0],this.unit=n[1]}},t.raw&&this.parse(t.raw)},newResult:function(t){return t||(t={}),new es.Result(t)},Result:function(t){this.data=t.raw,this.buckets=function(t){return this.data.aggregations[t].buckets},this.aggregation=function(t){return this.data.aggregations[t]},this.results=function(){var t=[];if(this.data.hits&&this.data.hits.hits)for(var e=0;e<this.data.hits.hits.length;e++){var i=this.data.hits.hits[e];"_source"in i?t.push(i._source):"fields"in i&&t.push(i.fields)}return t},this.total=function(){return this.data.hits&&this.data.hits.total?parseInt(this.data.hits.total):!1}},doQuery:function(t){var e=t.success,i=t.complete,s=t.search_url,r=t.queryobj,n=t.datatype,a=JSON.stringify(r);$.ajax({type:"get",url:s,data:{source:a},dataType:n,success:es.querySuccess(e),complete:i})},querySuccess:function(t){return function(e){var i=es.newResult({raw:e});t(i)}}};